# üì° API de Synology DSM - Gu√≠a de Integraci√≥n

## Contexto del Proyecto

Sistema web Django que se comunica con un NAS Synology a trav√©s de su API REST oficial.

**Stack Tecnol√≥gico:**
- Backend: Django (Python)
- NAS: Synology RS4017xs+ (DSM 7.0+)
- API: Synology DSM Web API
- Comunicaci√≥n: HTTP/HTTPS con autenticaci√≥n por sesi√≥n (SID + SynoToken)

---

## üîê 1. FLUJO DE AUTENTICACI√ìN

### Login (Obtener SID y SynoToken)

**Endpoint:** `/webapi/entry.cgi`  
**M√©todo:** `GET`

```python
params = {
    'api': 'SYNO.API.Auth',
    'version': 6,
    'method': 'login',
    'account': 'usuario',
    'passwd': 'contrase√±a',
    'session': 'FileStation',
    'format': 'sid',                    # Devuelve SID en JSON (no cookie)
    'enable_syno_token': 'yes'          # Genera token CSRF
}
```

**Respuesta exitosa:**
```json
{
    "success": true,
    "data": {
        "sid": "K5LlN6r-zkpxg61He2eSS2z...",
        "synotoken": "03yhfxW4syRQw",
        "did": "8nC0nhJjgiE1XTqM6..."
    }
}
```

**C√≥digos de error:**
- `400`: Usuario o contrase√±a incorrectos
- `403`: Requiere autenticaci√≥n 2FA
- `407`: IP bloqueada

### Uso de Credenciales

**TODAS las peticiones autenticadas deben incluir:**
```python
params = {
    'api': 'SYNO.FileStation.List',
    'version': 2,
    'method': 'list_share',
    '_sid': sid,              # ‚Üê OBLIGATORIO
    'SynoToken': syno_token   # ‚Üê OBLIGATORIO
}
```

### Logout

```python
params = {
    'api': 'SYNO.API.Auth',
    'version': 6,
    'method': 'logout',
    '_sid': sid
}
```

---

## üìö 2. APIS PRINCIPALES

### SYNO.Core.User (Gesti√≥n de Usuarios)

#### Listar Usuarios
```python
{
    'api': 'SYNO.Core.User',
    'version': 1,
    'method': 'list',
    '_sid': sid,
    'SynoToken': token
}
```

#### Crear Usuario
```python
{
    'api': 'SYNO.Core.User',
    'version': 1,
    'method': 'create',
    'name': 'nuevo_usuario',
    'password': 'contrase√±a',
    'description': 'Descripci√≥n opcional',
    'email': 'email@ejemplo.com',
    '_sid': sid,
    'SynoToken': token
}
```

#### Eliminar Usuario
```python
{
    'api': 'SYNO.Core.User',
    'version': 1,
    'method': 'delete',
    'name': 'usuario_a_eliminar',
    '_sid': sid,
    'SynoToken': token
}
```

---

### SYNO.FileStation.* (Gesti√≥n de Archivos)

#### Listar Carpetas Compartidas
```python
{
    'api': 'SYNO.FileStation.List',
    'version': 2,
    'method': 'list_share',
    '_sid': sid,
    'SynoToken': token
}
```

#### Listar Archivos en Carpeta
```python
{
    'api': 'SYNO.FileStation.List',
    'version': 2,
    'method': 'list',
    'folder_path': '/Compartido',
    'additional': '["real_path","size","owner","time"]',  # JSON string
    '_sid': sid,
    'SynoToken': token
}
```

#### Crear Carpeta
```python
{
    'api': 'SYNO.FileStation.CreateFolder',
    'version': 2,
    'method': 'create',
    'folder_path': '["/Compartido"]',  # JSON array como string
    'name': '["nueva_carpeta"]',       # JSON array como string
    '_sid': sid,
    'SynoToken': token
}
```

#### Eliminar Archivo/Carpeta
```python
{
    'api': 'SYNO.FileStation.Delete',
    'version': 2,
    'method': 'delete',
    'path': '["/Compartido/archivo.txt"]',  # JSON array
    '_sid': sid,
    'SynoToken': token
}
```

---

### Subir Archivos (POST multipart/form-data)

**IMPORTANTE:** Esta operaci√≥n usa `POST`, no `GET`

```python
url = f"{base_url}/webapi/entry.cgi"

data = {
    'api': 'SYNO.FileStation.Upload',
    'version': 2,
    'method': 'upload',
    'path': '/Compartido',           # Carpeta destino
    'create_parents': 'true',
    'overwrite': 'true',
    'SynoToken': token
}

files = {'file': open('archivo.pdf', 'rb')}
cookies = {'id': sid}  # SID va en cookie para uploads

response = requests.post(url, data=data, files=files, cookies=cookies, verify=False)
```

---

### SYNO.Core.Share.Permission (Gesti√≥n de Permisos)

```python
{
    'api': 'SYNO.Core.Share.Permission',
    'version': 1,
    'method': 'set',
    'name': 'Compartido',  # Nombre de carpeta compartida (sin /)
    'user_group': '[{"name":"usuario","is_group":false,"permission":"RW"}]',
    '_sid': sid,
    'SynoToken': token
}
```

**Permisos disponibles:**
- `RW`: Lectura y escritura
- `RO`: Solo lectura
- [NA](file:///d:/NasSystem/apps/settings/models.py#10-115): Sin acceso

---

## üìä 3. ESTRUCTURA DE RESPUESTAS

### Respuesta Exitosa
```json
{
    "success": true,
    "data": {
        // ... datos espec√≠ficos
    }
}
```

### Respuesta con Error
```json
{
    "success": false,
    "error": {
        "code": 400,
        "errors": [
            {
                "code": 408,
                "path": "/ruta/archivo"
            }
        ]
    }
}
```

### C√≥digos de Error Comunes
- `100`: Error desconocido
- `101`: Par√°metro faltante (api, method o version)
- `102`: API solicitada no existe
- `105`: Sin permisos
- `106`: Sesi√≥n expirada
- `119`: Sesi√≥n inv√°lida

---

## üîß 4. IMPLEMENTACI√ìN EN DJANGO

### Configuraci√≥n Din√°mica (NUNCA hardcodear)

```python
from apps.settings.models import NASConfig

# Obtener configuraci√≥n activa
config = NASConfig.get_active_config()
base_url = config.get_base_url()  # https://10.2.0.194:5001
username = config.admin_username
password = config.admin_password
```

### Clase SynologyAPI Base

**Ubicaci√≥n:** `apps/core/synology_api.py`

```python
import requests
import json

class SynologyAPI:
    def __init__(self, config):
        """Inicializar con instancia de NASConfig"""
        self.base_url = config.get_base_url()
        self.username = config.admin_username
        self.password = config.admin_password
        self.sid = None
        self.syno_token = None
        self.session = requests.Session()
        self.session.verify = False  # SSL en desarrollo
    
    def _request(self, api, method, version, **params):
        """M√©todo gen√©rico para peticiones GET"""
        url = f"{self.base_url}/webapi/entry.cgi"
        
        data = {
            'api': api,
            'version': version,
            'method': method,
        }
        
        # Agregar credenciales si ya autenticado
        if self.sid:
            data['_sid'] = self.sid
        if self.syno_token:
            data['SynoToken'] = self.syno_token
        
        data.update(params)
        
        try:
            response = self.session.get(url, params=data, timeout=30)
            result = response.json()
            
            if not result.get('success'):
                error_code = result.get('error', {}).get('code')
                raise Exception(f"API Error {error_code}")
            
            return result.get('data', {})
        
        except requests.exceptions.RequestException as e:
            raise Exception(f"Error de conexi√≥n: {str(e)}")
    
    def test_connection(self):
        """Prueba conexi√≥n sin autenticar"""
        try:
            url = f"{self.base_url}/webapi/entry.cgi"
            response = self.session.get(
                url,
                params={
                    'api': 'SYNO.API.Info',
                    'version': 1,
                    'method': 'query',
                    'query': 'SYNO.API.Auth'
                },
                timeout=10,
                verify=False
            )
            
            result = response.json()
            return {
                'success': result.get('success', False),
                'message': f'Conexi√≥n {"exitosa" if result.get("success") else "fallida"}'
            }
        
        except requests.exceptions.Timeout:
            return {'success': False, 'message': 'Timeout'}
        except requests.exceptions.ConnectionError:
            return {'success': False, 'message': 'No se puede conectar'}
        except Exception as e:
            return {'success': False, 'message': str(e)}
    
    def login(self):
        """Autenticarse y obtener SID + Token"""
        data = self._request(
            api='SYNO.API.Auth',
            version=6,
            method='login',
            account=self.username,
            passwd=self.password,
            session='FileStation',
            format='sid',
            enable_syno_token='yes'
        )
        
        self.sid = data.get('sid')
        self.syno_token = data.get('synotoken')
        self.session.cookies.set('id', self.sid)
        
        return True
    
    def logout(self):
        """Cerrar sesi√≥n"""
        self._request(
            api='SYNO.API.Auth',
            version=6,
            method='logout'
        )
        self.sid = None
        self.syno_token = None
```

---

## ‚úÖ 5. EJEMPLO COMPLETO DE USO

```python
from apps.settings.models import NASConfig
from apps.core.synology_api import SynologyAPI

# 1. Obtener configuraci√≥n
config = NASConfig.get_active_config()

# 2. Crear instancia API
api = SynologyAPI(config)

# 3. Login
api.login()

# 4. Operaciones
users = api._request('SYNO.Core.User', 'list', 1)
files = api._request('SYNO.FileStation.List', 'list_share', 2)

# 5. Logout
api.logout()
```

---

## ‚ùå NUNCA HACER

1. ‚ùå Hardcodear IPs o credenciales
2. ‚ùå Olvidar `_sid` y `SynoToken`
3. ‚ùå Usar GET para subir archivos (debe ser POST)
4. ‚ùå Olvidar cerrar sesi√≥n (logout)
5. ‚ùå Ignorar c√≥digos de error

## ‚úÖ SIEMPRE HACER

1. ‚úÖ `NASConfig.get_active_config()`
2. ‚úÖ `config.get_base_url()` para URLs
3. ‚úÖ Manejar excepciones y timeouts
4. ‚úÖ Validar `success: true`
5. ‚úÖ Arrays/objects como JSON strings
6. ‚úÖ Guardar SID/Token en sesi√≥n Django

---

## üß™ Vista de Prueba de Conexi√≥n

```python
from django.shortcuts import redirect
from django.contrib import messages
from apps.settings.models import NASConfig
from apps.core.synology_api import SynologyAPI

def test_nas_connection(request):
    config = NASConfig.get_active_config()
    
    if not config:
        messages.error(request, 'No hay configuraci√≥n activa')
        return redirect('settings:config')
    
    api = SynologyAPI(config)
    
    # Test 1: Conexi√≥n
    result = api.test_connection()
    if not result['success']:
        messages.error(request, result['message'])
        return redirect('settings:config')
    
    # Test 2: Autenticaci√≥n
    try:
        api.login()
        messages.success(request, '‚úÖ Conexi√≥n y autenticaci√≥n exitosa')
        api.logout()
    except Exception as e:
        messages.error(request, f'‚ùå Error: {str(e)}')
    
    return redirect('settings:config')
```

---

Esta documentaci√≥n es la referencia oficial para todas las integraciones con la API de Synology en el proyecto NAS Manager. üöÄ
