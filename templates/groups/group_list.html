{% extends "layouts/base.html" %}
{% load static %}

{% block content %}
<div class="h-full flex flex-col" x-data="groupManagement()">
    
    <!-- Toolbar -->
    <div class="px-6 py-4 flex items-center justify-between">
        <h1 class="text-2xl font-bold text-gray-800">Grupos</h1>
        
        <div class="flex items-center gap-3">
            <!-- Search -->
            <div class="relative">
                <input type="text" x-model="search" placeholder="Buscar..." 
                    class="pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-64">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
            
            <!-- Actions -->
            <button @click="refreshList()" class="p-2 text-gray-500 hover:text-gray-700 transition-colors" title="Actualizar">
                <i class="fas fa-sync-alt" :class="{'fa-spin': loading}"></i>
            </button>
            
            {% include "components/buttons/btn_primary.html" with text="Crear" icon="fas fa-plus" extra_attrs='@click="openCreateWizard()"' %}
            {% include "components/buttons/btn_primary.html" with text="Exportar" icon="fas fa-file-export" extra_attrs='@click="exportGroups()"' %}
        </div>
    </div>

    <!-- Content -->
    <div class="flex-1 overflow-auto bg-gray-50 p-6">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                         <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Estado
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Nombre
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Descripción
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Miembros
                        </th>
                         <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Acciones
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="group in filteredGroups" :key="group.name">
                        <tr class="hover:bg-gray-50 transition-colors">
                            <!-- Status -->
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full"
                                    :class="group.is_system ? 'bg-gray-100 text-gray-800' : 'bg-green-100 text-green-800'">
                                    <span x-text="group.is_system ? 'Sistema' : 'Normal'"></span>
                                </span>
                            </td>

                            <!-- Name -->
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900" x-text="group.name"></div>
                            </td>

                            <!-- Description -->
                            <td class="px-6 py-4">
                                <div class="text-sm text-gray-500 truncate max-w-xs" x-text="group.description || '-'"></div>
                            </td>

                            <!-- Members -->
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-500">
                                    <i class="fas fa-users mr-1 text-gray-400"></i>
                                    <span x-text="group.members ? group.members.length : 0"></span>
                                </div>
                            </td>

                            <!-- Actions -->
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <div class="flex items-center justify-end gap-3">
                                    <button @click="openEditWizard(group)" class="text-indigo-600 hover:text-indigo-900" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    
                                    <button @click="confirmDelete(group)" 
                                            :class="group.is_system ? 'text-gray-300 cursor-not-allowed' : 'text-red-600 hover:text-red-900'"
                                            :disabled="group.is_system"
                                            title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                    
                    <!-- Empty State -->
                     <tr x-show="filteredGroups.length === 0">
                        <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                             <div x-show="loading">
                                <i class="fas fa-circle-notch fa-spin text-2xl text-blue-500 mb-2"></i>
                                <p>Cargando grupos...</p>
                            </div>
                            <div x-show="!loading">
                                <i class="fas fa-users-slash text-3xl text-gray-300 mb-2"></i>
                                <p>No se encontraron grupos</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
         <!-- Pagination (Simplified for now) -->
        <div class="mt-4 flex items-center justify-between">
            <p class="text-xs text-gray-500" x-show="groups.length > 0">
                Mostrando <span x-text="filteredGroups.length"></span> de <span x-text="groups.length"></span>
            </p>
        </div>
    </div>

    <!-- Modals -->
    {% include "groups/modals/group_wizard.html" %}
    
    <!-- Delete Confirmation (SweetAlert used instead of template for simplicity and consistency with Wizard) -->

</div>

<script>
    function groupManagement() {
        return {
            groups: [],
            search: '',
            loading: false,

            get filteredGroups() {
                if (!this.search) return this.groups;
                const q = this.search.toLowerCase();
                return this.groups.filter(g => 
                    g.name.toLowerCase().includes(q) || 
                    (g.description && g.description.toLowerCase().includes(q))
                );
            },

            init() {
                this.loadGroups();
            },

            loadGroups() {
                this.loading = true;
                // Assuming URL exists or current page renders this
                // Ideally fetch from API, but if this is rendered from View with Context, we might bootstrap data.
                // But ref said "API consumption". So let's fetch.
                // Assuming "groups:list_api" or similar exists, or we use the current view if it returns JSON on request.
                // Let's use fetch to same URL with header or a specific API URL if defined in urls.py.
                // Checking views.py: GroupListView returns Template currently. 
                // We should add a fetch method? Or bootstrap in script.
                // Let's rely on bootstrapping if `groups` context is passed, otherwise fetch.
                
                // Better approach for Single Page feel: Fetch JSON.
                 fetch('{% url "groups:list" %}?format=json') 
                    .then(r => r.json())
                    .then(data => {
                        this.groups = data.groups;
                    })
                    .catch(e => console.error("Error loading groups", e))
                    .finally(() => this.loading = false);
            },
            
            refreshList() {
                this.loadGroups();
            },

            openCreateWizard() {
                // Dispatch event to Wizard Component
                window.dispatchEvent(new CustomEvent('group-wizard-init', {
                    detail: { mode: 'create' }
                }));
            },

            openEditWizard(group) {
                window.dispatchEvent(new CustomEvent('group-wizard-init', {
                    detail: { mode: 'edit', groupName: group.name }
                }));
            },
            
            confirmDelete(group) {
                if(group.is_system) return;
                
                Swal.fire({
                    title: '¿Eliminar grupo?',
                    text: `Se eliminará el grupo "${group.name}". Esta acción no se puede deshacer.`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc2626',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        this.deleteGroup(group.name);
                    }
                });
            },

            deleteGroup(name) {
                // Post to delete endpoint
                const formData = new FormData();
                formData.append('name', name);
                
                fetch('{% url "groups:delete" %}', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                    body: formData
                })
                .then(r => r.json())
                .then(resp => {
                    if(resp.success) {
                        Swal.fire('Eliminado', 'El grupo ha sido eliminado.', 'success');
                        this.loadGroups();
                    } else {
                        Swal.fire('Error', resp.message, 'error');
                    }
                });
            },
            
            exportGroups() {
                window.location.href = '{% url "groups:export" %}';
            }
        }
    }
</script>
{% endblock %}