<!-- Wizard Modal -->
<div x-show="wizardOpen" style="display: none;" 
    class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    
    <!-- Backdrop -->
    <div x-show="wizardOpen" 
        x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
        x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
        class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="wizardOpen = false"></div>

    <!-- Modal Panel -->
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:p-0">
        
        <!-- This inner div handles the modal panel itself -->
        <div class="bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:max-w-4xl sm:w-full h-[600px] flex relative"
            x-data="wizardLogic()">
            
            <!-- Left Sidebar (Stepper) -->
            <div class="w-64 bg-gray-50 border-r border-gray-200 flex flex-col pt-8 pb-6 px-4">
                <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-6 px-2">
                    <span x-text="mode === 'create' ? 'Nuevo Usuario' : 'Editar Usuario'"></span>
                </h3>
                
                <nav class="space-y-1 flex-1">
                    <template x-for="(step, index) in steps" :key="index">
                        <button :disabled="currentStep < index + 1" 
                            class="w-full group flex items-center px-2 py-2 text-xs font-medium rounded-md transition-colors"
                            :class="{ 
                                'bg-indigo-50 text-indigo-700': currentStep === index + 1,
                                'text-gray-600 hover:bg-gray-100': currentStep !== index + 1,
                                'opacity-50 cursor-not-allowed': currentStep < index + 1
                             }">
                            <span class="w-6 h-6 flex items-center justify-center rounded-full border mr-3 text-[10px]"
                                  :class="{
                                      'bg-indigo-600 text-white border-indigo-600': currentStep === index + 1 || currentStep > index + 1,
                                      'border-gray-300': currentStep < index + 1
                                  }" x-text="index + 1">
                            </span>
                            <span x-text="step.label"></span>
                        </button>
                    </template>
                </nav>
            </div>

            <!-- Right Content -->
            <div class="flex-1 flex flex-col bg-white">
                
                <!-- Main Content Area (Scrollable) -->
                <div class="flex-1 p-8 overflow-y-auto">
                    <!-- Loading State -->
                    <div x-show="loading" class="h-full flex flex-col items-center justify-center text-gray-400">
                        <i class="fas fa-circle-notch fa-spin text-3xl mb-3 text-indigo-500"></i>
                        <span class="text-sm">Cargando datos...</span>
                    </div>

                    <!-- Steps Content -->
                    <div x-show="!loading">
                        <form id="wizardForm">
                            {% include "usuarios/wizard/step_1_info.html" %}
                            {% include "usuarios/wizard/step_2_groups.html" %}
                            {% include "usuarios/wizard/step_3_permissions.html" %}
                            {% include "usuarios/wizard/step_4_quota.html" %}
                            {% include "usuarios/wizard/step_5_apps.html" %}
                            {% include "usuarios/wizard/step_6_speed.html" %}
                            {% include "usuarios/wizard/step_7_confirm.html" %}
                        </form>
                    </div>
                </div>

                <!-- Footer Buttons -->
                <div class="px-8 py-4 bg-gray-50 border-t border-gray-200 flex justify-between items-center shrink-0">
                    <button @click="wizardOpen = false" type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Cancelar
                    </button>
                    
                    <div class="flex space-x-3">
                        <button x-show="currentStep > 1" @click="prevStep()" type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Atrás
                        </button>
                        
                        <button x-show="currentStep < 7" @click="nextStep()" type="button" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Siguiente
                        </button>
                        
                        <button x-show="currentStep === 7" @click="submitWizard()" type="button" 
                            class="px-4 py-2 text-sm font-medium text-white bg-green-600 border border-transparent rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 inline-flex items-center"
                            :disabled="submitting">
                            <i x-show="submitting" class="fas fa-circle-notch fa-spin mr-2"></i>
                            <span x-text="submitting ? 'Aplicando...' : 'Finalizar'"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function wizardLogic() {
        return {
            currentStep: 1,
            loading: false,
            submitting: false,
            options: {}, // Stores Groups, Shares, etc fetched from API
            
            // Form Data Model
            formData: {
                info: { name: '', password: '', passwordConfirm: '', email: '', description: '' }, // Added passwordConfirm
                groups: [], 
                permissions: {}, 
                quota: {},
                apps: [],
                speed: {
                    upload_value: 0, upload_unit: 'KB',
                    download_value: 0, download_unit: 'KB'
                }
            },
            
            // Password Strength State
            strength: 0,
            strengthLabel: '',
            
            get strengthColor() {
                if (this.strength === 1) return 'bg-red-500';
                if (this.strength === 2) return 'bg-yellow-500';
                if (this.strength >= 3) return 'bg-green-500';
                return 'bg-gray-200';
            },
            
            get strengthTextColor() {
                if (this.strength === 1) return 'text-red-500';
                if (this.strength === 2) return 'text-yellow-600';
                if (this.strength >= 3) return 'text-green-600';
                return 'text-gray-400';
            },
            
            get passwordsMatch() {
                 return !this.formData.info.password || // Don't show error if empty
                        this.formData.info.password === this.formData.info.passwordConfirm;
            },

            steps: [
                { label: 'Información' },
                { label: 'Unirse a grupos' },
                { label: 'Permisos carpetas' },
                { label: 'Cuota de usuario' },
                { label: 'Aplicaciones' },
                { label: 'Límites de velocidad' },
                { label: 'Confirmar' }
            ],

            init() {
                // Listen event from parent to reset
                this.$watch('wizardOpen', value => {
                    if (value && !this.options.groups) {
                        this.fetchData();
                    }
                    if (value) {
                         // Reset fields on open if needed
                    } else {
                        // FULL RESET ON CLOSE/CANCEL
                        this.currentStep = 1;
                        this.strength = 0;
                        this.strengthLabel = '';
                        this.formData = {
                            info: { name: '', password: '', passwordConfirm: '', email: '', description: '' },
                            groups: [], 
                            permissions: {}, 
                            quota: {},
                            apps: [],
                            speed: { upload_value: 0, upload_unit: 'KB', download_value: 0, download_unit: 'KB' }
                        };
                    }
                });
            },
            
            checkStrength() {
                const val = this.formData.info.password;
                let s = 0;
                if(val.length > 5) s++;
                if(val.length > 8) s++;
                if(/[A-Z]/.test(val) && /[0-9]/.test(val)) s++;
                
                this.strength = s;
                if(s === 0) this.strengthLabel = '';
                else if(s === 1) this.strengthLabel = 'Débil';
                else if(s === 2) this.strengthLabel = 'Media';
                else this.strengthLabel = 'Fuerte';
            },

            fetchData() {
                this.loading = true;
                fetch('{% url "usuarios:wizard_api" %}')
                    .then(r => r.json())
                    .then(resp => {
                        if (resp.success) {
                            this.options = resp.data;
                            
                            // Pre-select default group 'users'
                            if(!this.formData.groups.includes('users')) {
                                this.formData.groups.push('users');
                            }
                        } else {
                             console.error("Error loading options:", resp.message);
                             Swal.fire('Error', 'No se pudieron cargar opciones: ' + resp.message, 'error');
                        }
                    })
                    .catch(err => {
                        console.error("Fetch options error", err);
                        Swal.fire('Error de conexión', 'No se pudieron cargar las opciones del NAS.', 'error');
                    })
                    .finally(() => this.loading = false);
            },

            nextStep() {
                // Validation logic per step
                if (this.currentStep === 1) {
                    if (!this.formData.info.name) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Campo requerido',
                            text: 'Por favor ingrese un nombre de usuario.',
                            confirmButtonColor: '#4f46e5'
                        });
                        return;
                    }
                    
                    // Password Validation (only if create mode or password is typed)
                    if (this.mode === 'create' || this.formData.info.password) {
                        if (!this.formData.info.password) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Contraseña requerida',
                                text: 'Debe asignar una contraseña al nuevo usuario.',
                                confirmButtonColor: '#4f46e5'
                            });
                            return;
                        }
                        if (this.formData.info.password !== this.formData.info.passwordConfirm) {
                             Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Las contraseñas no coinciden.',
                                confirmButtonColor: '#4f46e5'
                            });
                            return;
                        }
                    }
                }
                if (this.currentStep < 7) this.currentStep++;
            },
            
            prevStep() {
                if (this.currentStep > 1) this.currentStep--;
            },

            submitWizard() {
                this.submitting = true;
                
                fetch('{% url "usuarios:wizard_api" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(this.formData)
                })
                .then(r => r.json())
                .then(resp => {
                    if(resp.success) {
                        Swal.fire({
                            icon: 'success',
                            title: '¡Éxito!',
                            text: 'Operación completada correctamente.',
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => {
                            window.location.reload();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error del NAS',
                            text: resp.message || 'Ocurrió un error desconocido.',
                            confirmButtonColor: '#d33'
                        });
                    }
                })
                .catch(err => {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de Conexión',
                        text: String(err),
                        confirmButtonColor: '#d33'
                    });
                })
                .finally(() => this.submitting = false);
            }
        }
    }
</script>
